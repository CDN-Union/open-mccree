!function(e){function t(i){if(r[i])return r[i].exports;var a=r[i]={exports:{},id:i,loaded:!1};return e[i].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){(function(i){"use strict";var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(r,i){"function"==typeof r.define&&r.define.amd?r.define(["PandaMccreeLive"],i):"object"===a(t)?e.exports=i(r.PandaMccreeLive):r.PandaMccreeLive=i(r.PandaMccreeLive),r.PandaMccreeLive=i(r.PandaMccreeLive)}("undefined"==typeof window?i:window,function(e){return e=r(1).default})}).call(t,function(){return this}())},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.PandaMccreeLive=void 0;var o=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),u=r(2),c=i(u),l=r(9),h=i(l),d=r(11),f=i(d),m=r(!function(){var e=new Error('Cannot find module "mccree-loader-tencentp2p"');throw e.code="MODULE_NOT_FOUND",e}()),v=(i(m),r(12)),p=i(v),g=r(13),y=i(g),b=r(14),_=i(b),k=r(21),T=i(k),E=t.PandaMccreeLive=function(e){function t(e,r){a(this,t);var i=y.default.uaMatch(navigator.userAgent),n=null;n=i.mozilla?new f.default:new h.default;var o=new _.default,u=new T.default;r=r||{},r.autoReload||(r.autoReload=6e3),r.loaderBufferLimit=r.loaderBufferLimit||5e7;var c=null;e.logger&&(c=e.logger);var l=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,{logger:c,loader:n,demux:o,remux:u},r));return l.logger.debug("PandaMccreeLive","mccree","正在启动播放装置。"),l.initStatistic(),l.version="1.1.38",l.mseController=new p.default,l.mseController.init(l),l.on=l.observer.on,l}return n(t,e),o(t,[{key:"isSupport",value:function(){return!0}},{key:"checkState",value:function(){this.reloading||this.mseController.checkState()}},{key:"clearBuffer",value:function(){this.mseController.clearBuffer()}},{key:"load",value:function(e){this.logger.log(this.TAG,"loadurl "+e),this.originUrl=e,this.loader.load(e)}},{key:"play",value:function(){this.mediaElement.play()}},{key:"destroy",value:function(){var e=this,t=this;this.logger.debug(t.TAG,"destroy","正在销毁播放装置。"),this.off();var r=new Promise(function(r,i){clearInterval(t.statisticTimmer),t.statisticTimmer=null,t.unload().then(function(i){return e.mediaSource&&e.asourceBuffer&&e.vsourceBuffer?(t.mseController.destroy(),t.detachMedia(),e.media=null,t.cdnip=null,t.loader=null,t.remux=null,t.demux=null,t.logger.debug(t.TAG,"unload","正在播放装置完全解除。"),void r("destroyed")):void r("already destroyed")}).catch(function(e){r("destroyed")})});return r}},{key:"pause",value:function(){this.mseController.pause()}},{key:"reload",value:function(){var e=this,t=(this.originUrl,this);return new Promise(function(r,i){t.reloading=!0,t.loader.unload().then(function(i){t.observer.trigger("error",e.events.errorTypes.NETWORK_ERROR,{}),t.observer.off("FRAME_DROPPED"),t.media.tracks={},t.remuxBuffer={audio:[],video:[]},t.loaderBuffer.clear(),t.demux.reset(),t.remux.destroy(),t.mseController.destroy(),r()}).catch(function(e){t.reloading=!1,r()})})}},{key:"getMediaElement",value:function(){return this.mseController.mediaElement}},{key:"initStatistic",value:function(){this.loadbytes=0,this.droppedFrames=0,this.decodedFrames=0;var e=this;this.observer.on(this.events.events.FRAG_LOADED,function(t){e.loadbytes+=t}),this.observer.on("MEDIA_SEGMENT_REMUXED",function(t){t&&(e.decodedFrames+=t)}),this.observer.on("FRAME_DROPPED",function(t){t&&(e.droppedFrames+=t)}),this.statisticTimmer=setInterval(this._onStatistic.bind(this),1e3)}},{key:"_onStatistic",value:function(){try{this.statisticTimmer&&(this.observer.trigger("statistics_info",{droppedFrames:this.droppedFrames,decodedFrames:this.decodedFrames+this.droppedFrames,speed:Math.floor(this.loadbytes/1e3)}),this.loadbytes=0)}catch(e){}}},{key:"attachMediaElement",value:function(e){e&&this.mseController.attachMediaElement(e)}},{key:"recordStartTime",value:function(){this.startTime||(this.startTime=(new Date).getTime())}},{key:"detachMediaElement",value:function(){this.mseController.detachMediaElement()}}]),t}(c.default);t.default=E},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=r(3),o=i(n),u=r(4),c=i(u),l=r(5),h=i(l),d=r(6),f=i(d),m=r(7),v=i(m),p=r(8),g=(i(p),function(){function e(t,r,i){a(this,e),t||(t={}),this.TAG="Mccree",this.config=r?r:{},this.debug=r&&r.debug||!1,this.plugins=i||[],this.url=null,this.time=0,this.events=f.default,this.logMsgs=f.default.logMsgs,Object.assign(this.logMsgs,this.config.logMessages||{}),this._initLogger(t.logger),this.initObserver(),this.loaderBuffer=new v.default,this.remuxBuffer={},this.initSegment={},this._createModules(t),this._initModules();var s=new h.default;this.attachMedia(s)}return s(e,[{key:"destroy",value:function(){var e=this;return clearInterval(this.timmer),this.timmer=null,this.unload().then(function(t){e.observer=null,e.detachMedia(),e.media=null,e.logger.debug(e.TAG,"unload",e.logMsgs.DESTROY)})}},{key:"attachMedia",value:function(e){this.detachMedia(),this.media=e}},{key:"detachMedia",value:function(){this.media=null}},{key:"attachMediaElement",value:function(e){this.detachMedia(),this.mediaElement=e}},{key:"detachMediaElement",value:function(){this.mediaElement=null}},{key:"load",value:function(e){this.logger.log(this.TAG,"loadurl "+e),this.originUrl=e,this.loader.load(e)}},{key:"unload",value:function(){var e=this;return new Promise(function(t,r){e.loader?(e.logger.debug(e.TAG,"unload",e.logMsgs.UNLOADING),e.loader.unload().then(function(e){t()}).catch(function(e){r(e)})):t()})}},{key:"_initLogger",value:function(e){e&&o.default.isValid(e)?(this.logger=new o.default(e,(!1),this.debug),this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_LOGGER_CUSTOM)):(this.logger=new o.default(null,(!1),this.debug),this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_LOGGER_INTERNAL))}},{key:"initObserver",value:function(){var e=this;this.observer=new c.default,this.observer.trigger=function(t){for(var r=arguments.length,i=Array(r>1?r-1:0),a=1;a<r;a++)i[a-1]=arguments[a];if("error"!==t){var s;(s=e.observer).emit.apply(s,[t].concat(i))}else{var n;(n=e.observer).emit.apply(n,["internalError"].concat(i))}},this.observer.on=function(t,r){"error"!==t?e.observer.addListener(t,r):e.observer.addListener("internalError",r)},this.observer.off=function(t,r){r||(r=function(){}),t?"error"!==t?e.observer.removeListener(t,r):e.observer.removeListener("internalError",r):(e.observer.removeAllListeners(),r())},this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_OBSERVER),this.on=this.observer.on.bind(this.observer),this.off=this.observer.off.bind(this.observer),this.trigger=this.observer.trigger.bind(this.observer)}},{key:"_createModules",value:function(e){e.loader?(this.loader=e.loader,this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_LOADER)):this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_LOADER_FAIL),e.demux?(this.demux=e.demux,this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_DEMUXER)):this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_DEMUXER_FAILED),e.remux?(this.remux=e.remux,this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_REMUXER)):this.logger.debug(this.TAG,"debug",this.logMsgs.INIT_REMUXER_FAILED)}},{key:"_initModules",value:function(){this.loader&&this.loader.init(this),this.demux&&this.demux.init(this),this.remux&&this.remux.init(this)}}]),e}());t.default=g},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(t,i,a){r(this,e),this.disabled=i,this.debuging=a,this._logger=t}return i(e,[{key:"log",value:function(e,t,r){if(!this.disabled)if(this._logger)this._logger.log(e,t,r);else{var i=(new Date).toLocaleString();window&&window.console&&window.console.log("["+i+"]["+e+"] "+t+": ",r)}}},{key:"info",value:function(e,t,r){if(!this.disabled)if(this._logger)this._logger.info(e,t,r);else{var i=(new Date).toLocaleString();window&&window.console&&window.console.info("["+i+"]["+e+"] "+t+": "+r)}}},{key:"warn",value:function(e,t,r){if(!this.disabled)if(this._logger)this._logger.warn(e,t,r);else{var i=(new Date).toLocaleString();window&&window.console&&window.console.warn("["+i+"]["+e+"] "+t+": "+r)}}},{key:"debug",value:function(e,t,r){if(!this.disabled&&this.debuging)if(this._logger)this._logger.debug(e,t,r);else{var i=(new Date).toLocaleString();window&&window.console&&window.console.debug("["+i+"]["+e+"] "+t+": ",r)}}},{key:"error",value:function(e,t,r){if(!this.disabled)if(this._logger)this._logger.error(e,t,r);else{var i=(new Date).toLocaleString();window&&window.console&&window.console.debug("["+i+"]["+e+"] "+t+": "+r)}}}],[{key:"isValid",value:function(e){return!!(e&&e.info&&e.log&&e.debug&&e.error&&e.warn)}}]),e}();t.default=a},function(e,t){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}function i(e){return"function"==typeof e}function a(e){return"number"==typeof e}function s(e){return"object"==typeof e&&null!==e}function n(e){return void 0===e}e.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){if(!a(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this},r.prototype.emit=function(e){var t,r,a,o,u,c;if(this._events||(this._events={}),"error"===e&&(!this._events.error||s(this._events.error)&&!this._events.error.length)){if(t=arguments[1],t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}if(r=this._events[e],n(r))return!1;if(i(r))switch(arguments.length){case 1:r.call(this);break;case 2:r.call(this,arguments[1]);break;case 3:r.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),r.apply(this,o)}else if(s(r))for(o=Array.prototype.slice.call(arguments,1),c=r.slice(),a=c.length,u=0;u<a;u++)c[u].apply(this,o);return!0},r.prototype.addListener=function(e,t){var a;if(!i(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,i(t.listener)?t.listener:t),this._events[e]?s(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,s(this._events[e])&&!this._events[e].warned&&(a=n(this._maxListeners)?r.defaultMaxListeners:this._maxListeners,a&&a>0&&this._events[e].length>a&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace())),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function r(){this.removeListener(e,r),a||(a=!0,t.apply(this,arguments))}if(!i(t))throw TypeError("listener must be a function");var a=!1;return r.listener=t,this.on(e,r),this},r.prototype.removeListener=function(e,t){var r,a,n,o;if(!i(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(r=this._events[e],n=r.length,a=-1,r===t||i(r.listener)&&r.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if(s(r)){for(o=n;o-- >0;)if(r[o]===t||r[o].listener&&r[o].listener===t){a=o;break}if(a<0)return this;1===r.length?(r.length=0,delete this._events[e]):r.splice(a,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this},r.prototype.removeAllListeners=function(e){var t,r;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(r=this._events[e],i(r))this.removeListener(e,r);else if(r)for(;r.length;)this.removeListener(e,r[r.length-1]);return delete this._events[e],this},r.prototype.listeners=function(e){var t;return t=this._events&&this._events[e]?i(this._events[e])?[this._events[e]]:this._events[e].slice():[]},r.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(i(t))return 1;if(t)return t.length}return 0},r.listenerCount=function(e,t){return e.listenerCount(t)}},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(t,i){r(this,e),this.TAG="MccreeMedia",this.config=t||{},this.level=null,this.tracks=i||{},this.mediaInfo={},this.videoDuration=0,this.audioDuration=0}return i(e,[{key:"initTracks",value:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[Object.keys(this.tracks)[e]].reset()}},{key:"resetTracks",value:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[Object.keys(this.tracks)[e]].reset()}},{key:"getTrack",value:function(e){return this.tracks[e]}},{key:"destoryTracks",value:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[Object.keys(this.tracks)[e]].destroy()}}]),e}();t.default=a},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={UNLOAD:"unload",DESTROY:"destroy",MEDIA_ATTACHING:"mediaAttaching",MEDIA_ATTACHED:"mediaAttached",MEDIA_DETACHING:"mediaDetaching",MEDIA_DETACHED:"mediaDetached",NOT_FOUND:"notFound",FORBIDDEN:"forbidden",CONNECTED:"connected",FRAG_LOADED:"fragLoaded",FRAG_PARSED:"fragParsed",FPS_DROP:"fpsDrop",BUFFER_APPENDING:"bufferAppending",BUFFER_APPENDED:"bufferAppended",BUFFER_EOS:"bufferEos",BUFFER_FLUSHING:"bufferFlushing",BUFFER_FLUSHED:"bufferFlushed",DEMUXER_MISSMATCH:"demuxerMissmatch",NO_MEDIA_ATTACHED:"noMeidaAttached",ERROR:"error"},i={NETWORK_ERROR:"NetworkError",MEDIA_ERROR:"MediaError",MUX_ERROR:"MuxError",OTHER_ERROR:"OtherError"},a={NOT_INITED:"notInited",NOT_FOUND:"notFound",FORBIDDEN:"forbidden",UNKNOWN:"unknown",DATA_LENGTH_MISSMATCH:"dataLengthMissMatch"},s={NOT_INITED:"This module is not init yet",CONNECTED:"Connected to the source",NOT_FOUND:"The source is not founded",FORBIDDEN:"forbidden",UNKNOWN:"unknown",DESTROY:"Destroy mccree",UNLOADING:"Unloading",INIT_LOGGER_CUSTOM:"Logger initialized, use the customer logger",INIT_LOGGER_INTERNAL:"Logger initialized, use the internal logger",INIT_LOADER:"Loader initialized",INIT_LOADER_FAIL:"Loader can not be initialized",INIT_DEMUXER:"Demuxer initialized",INIT_DEMUXER_FAILED:"Demuxer can not be initialized",INIT_REMUXER:"Remuxer initialized",INIT_REMUXER_FAILED:"Remuxer can not be initialized"},n={events:r,errorTypes:i,errorDetails:a,logMsgs:s};t.default=n},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(t){r(this,e),this.length=t?t:0,this.array=[],this.offset=0}return i(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var r=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,r}for(var i=new Uint8Array(e),a=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var s=this.array[0].slice(this.offset,this.offset+e);i.set(s,a),this.offset+=e,this.length-=e,e=0;break}var n=this.array[0].length-this.offset;i.set(this.array[0].slice(this.offset,this.array[0].length),a),this.array.shift(),this.offset=0,a+=n,this.length-=n,e-=n}return i}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"shiftBuffer",value:function(){this.array.length>0&&(this.length-=this.array[0].length,this.array.shift(),this.offset=0)}},{key:"toInt",value:function(e,t){for(var r=0,i=this.offset+e;i<this.offset+t+e;)i<this.array[0].length?r=256*r+this.array[0][i]:this.array[1]&&(r=256*r+this.array[1][i-this.array[0].length]),i++;return r}}]),e}();t.default=a},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=t.Utils=function(){function e(){r(this,e)}return i(e,null,[{key:"getUint",value:function(e){for(var t=0,r=0;r<e.length;)t=256*t+e[r],r++;return t}},{key:"initMccree",value:function(e){if(!e)throw new Error("mccree is not defined");if(!e.events)throw new Error("mccree events is not defined");this.mccree=e,this.logger=e.logger,this.observer=e.observer,this.events=e.events.events,this.errorTypes=e.events.errorTypes,this.errorDetails=e.events.errorDetails,this.logMsgs=e.events.logMsgs}},{key:"extend",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];if(!(t.length<1))for(var i=1,a=t.length;i<a;i++)for(var s=Object.keys(t[i]),n=0,o=s.length;n<o;n++)t[0][s[n]]=t[i][s[n]]}}]),e}();t.default=a},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),o=r(10),u=i(o),c=function(){function e(t){a(this,e),this.TAG="FetchLoader",this.type="loader",this.configs=t||{},this.status=0,this.error=null,this._reader=null}return n(e,null,[{key:"isSupported",value:function(){return!!(self.fetch&&self.ReadableStream&&Uint8Array)}}]),n(e,[{key:"init",value:function(e){this.controller=new u.default(this),this.controller.init.call(this,e)}},{key:"load",value:function(e,t,r){this.loading===!0&&this.unload(),this.mccree.loaderBuffer.clear(),this.loadPartail(e,{start:-1,end:-1},t)}},{key:"loadPartail",value:function(e,t,r){if(void 0===this.mccree)return void this.logger.debug(this.TAG,"Uninitailized","this module is not init yet");this.source=e;var i=this._getParams(t,r),a=self.fetch(e,i),s=this;a.then(function(e){return s._status=e.status,s.loading=!0,s._onFetchResponse.call(s,e)}).catch(this._onFetchException.bind(this))}},{key:"unload",value:function(){var e=this,t=this;return new Promise(function(r,i){t.loading||r(),t.loading=!1,t.mccree.loaderBuffer.clear(),void 0!==t._reader?t._reader.cancel().then(function(){t.loading=!1,r()}):(t.loading=!1,r()),e.destroyResolve=r})}},{key:"_getParams",value:function(e,t){var r=t||{},i=new self.Headers,a={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===s(this.configs.headers)){var n=this.configs.headers;for(var o in n)n.hasOwnProperty(o)&&i.append(o,n[o])}return r.cors===!1&&(a.mode="same-origin"),r.withCredentials&&(a.credentials="include"),a}},{key:"_onFetchResponse",value:function(e){return this.mccree.url=e.url||this.mccree.url,e.ok===!0?(this.controller.onConnected.call(this,e),this._onReader.call(this,e.body.getReader())):void(404==e.status?this.controller.onNotfound.call(this,e):403==e.status?this.controller.onForbidden.call(this,e):this.controller.onUnknownError.call(this,e))}},{key:"_onFetchException",value:function(e){this.logger.debug(this.TAG,this.type,this.logMsgs.UNKNOWN),this.observer.trigger("error",this.errorTypes.NETWORK_ERROR,e)}},{key:"_onReader",value:function(e){if(this._reader=e,this.loading!==!1){var t=this;this._reader&&this._reader.read().then(function(r){return void 0!==t&&r.done===!0?(t.loading=!1,t.logger.debug(t.TAG,t.type,"Loading Finished"),void(void 0!==t.destroyResolve?(t.destroyResolve(),t.destroyResolve=void 0):t.observer.trigger("error",t.errorTypes.NETWORK_ERROR,t.errorDetails.NOT_FOUND))):(t.mccree.loaderBuffer.push(r.value),t.observer.trigger(t.events.FRAG_LOADED,r.value.byteLength),t._onReader(e))}).catch(function(e){t.observer.trigger("error",t.errorTypes.NETWORK_ERROR,e.message)})}}}]),e}();t.default=c},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(t){r(this,e),this.loader=t,this.loader.loading=!1,this.loader.connected=!1,this.loader.source=null,this.loader.responseUrl=null,this.loader.cdnip=null}return i(e,[{key:"init",value:function(e){this.mccree=e,this.logger=e.logger,this.observer=e.observer,this.events=e.events.events,this.errorTypes=e.events.errorTypes,this.errorDetails=e.events.errorDetails,this.logMsgs=e.events.logMsgs}},{key:"onConnected",value:function(){this.connected||this.logger.debug(this.TAG,this.type,this.logMsgs.CONNECTED),this.connected=!0}},{key:"onLoadData",value:function(e){this.connected=!0,this.loading=!0,this.observer.trigger(this.events.FRAG_LOADED,e)}},{key:"onNotfound",value:function(e){this.connected=!1,this.loading=!1,this.logger.debug(this.TAG,this.type,this.logMsgs.NOT_FOUND),this.observer.trigger("error",this.errorTypes.NETWORK_ERROR,this.errorDetails.NOTFOUND,e)}},{key:"onForbidden",value:function(e){this.connected=!1,this.loading=!1,this.logger.debug(this.TAG,this.type,this.logMsgs.FORBIDDEN),this.observer.trigger("error",this.errorTypes.NETWORK_ERROR,this.errorDetails.NOTFOUND,e)}},{key:"onUnknownError",value:function(e){this.connected=!1,this.loading=!1,this.logger.debug(this.loader.TAG,this.loader.type,this.logMsgs.NOT_FOUND),this.observer.trigger("error",this.errorTypes.NETWORK_ERROR,this.errorDetails.NOTFOUND,e)}}]),e}();t.default=a},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=r(10),o=i(n),u=function(){function e(t){a(this,e),this.TAG="MozXhrLoader",this.type="loader",this.config=t||{}}return s(e,null,[{key:"isSupported",value:function(){}}]),s(e,[{key:"init",value:function(e){this.controller=new o.default(this),this.controller.init.call(this,e)}},{key:"load",value:function(e,t){this._cleanLoaderBuffer(),this.loadPartail(e,{start:-1,end:-1},t)}},{key:"loadPartail",value:function(e,t,r){var i=this;if(!this.mccree)return void this.logger.debug(this.TAG,"Uninitailized","this module is not init yet");this.source=e,this._loading=!1,this.xhr=new XMLHttpRequest;var a=this;this.xhr.open("get",e,!0),this.xhr.responseType="moz-chunked-arraybuffer",this.xhr.onreadystatechange=function(e){200===i.status?a.controller.onConnected.call(a,e):404===i.status&&a.controller.onNotfound.call(a,e)},this.xhr.onprogress=function(e){a.mccree.url=i.xhr.response.url||a.mccree.url;var t=e.target.response;a.mccree.loaderBuffer.push(new Uint8Array(t)),a.observer.trigger(a.events.FRAG_LOADED,t.byteLength)},this.xhr.send()}},{key:"unload",value:function(){var e=this,t=this;return new Promise(function(r,i){t._loading=!1,t._cleanLoaderBuffer(),e.xhr.onprogress=null,e.xhr.abort(),r()})}},{key:"_cleanLoaderBuffer",value:function(){this.mccree.loaderBuffer.clear()}}]),e}();window.MozXhrLoader=u,t.default=u},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){r(this,e),this.TAG="MSEController",this.type="plugin",this.mediaSource=new window.MediaSource,this._lastappand="audio",this.mediaElement=null,this.seekables=[],this.mccree=null,this.observer=null,this.config=null,this._initAppanded=!1,this._lastappand="audio",this.mediaElement=null,this.lastSeek=-1,this.startTime=void 0,this._lastClearTime=0}return i(e,[{key:"init",value:function(e){this.mccree=e,this.observer=e.observer,this.config=e.config,this.logger=e.logger,this.observer.on("MEDIA_SEGMENT_REMUXED",this._onMediaSegment.bind(this))}},{key:"play",value:function(){this.mediaElement.play()}},{key:"checkState",value:function(){if(this.config.autoReload>15e3&&this.mediaElement&&this.mediaElement.readyState<3&&(new Date).getTime()-this.startTime-1e3*this.mediaElement.currentTime>this.config.autoReload){var e=this;this.mccree.reload().then(function(){e.startTime=void 0})}this.seekables[this.seekables.length-1]>this.lastSeek&&this.mediaElement&&2===this.mediaElement.readyState&&this.seekables.length>1&&(this.mediaElement.currentTime=this.seekables[this.seekables.length-1]/1e3,this.lastSeek=this.seekables[this.seekables.length-1]),this.seekables[this.seekables.length-1]>this.lastSeek&&this.mediaElement&&1===this.mediaElement.readyState&&this.mediaElement.currentTime>0&&this.seekables.length>1&&(this.mediaElement.currentTime=this.seekables[this.seekables.length-1]/1e3,this.lastSeek=this.seekables[this.seekables.length-1]),this.seekables[this.seekables.length-1]>this.lastSeek&&this.mediaElement&&this.seekables.length>1&&this.mediaElement.readyState<3&&this.mediaElement.currentTime<this.seekables[this.seekables.length-1]/1e3-10&&(this.mediaElement.currentTime=this.seekables[this.seekables.length-1]/1e3,this.lastSeek=this.seekables[this.seekables.length-1],this.logger.debug("PandaMccreeLive","mccree","储能槽能量剩余，正在追帧。追帧至"+this.seekables[this.seekables.length-1]/1e3)),this._onMediaSegment()}},{key:"clearBuffer",value:function(){if(this.mediaElement&&!(((new Date).getTime()-this.startTime-this._lastClearTime)/1e3<30)){var e=this.mediaElement.currentTime;if(!(e-this._lastClearTime<30)&&this.asourceBuffer&&this.vsourceBuffer&&!this.vsourceBuffer.updating&&!this.asourceBuffer.updating)for(this.vsourceBuffer.remove(this._lastClearTime,e-10),this.asourceBuffer.remove(this._lastClearTime,e-10),this._lastClearTime=e-10,this.logger.debug(this.TAG,"PandaMccreeLive","正在清洗能量槽");this.seekables&&this.seekables.length>0&&this.seekables[0]/1e3<e-10;)this.seekables.shift()}}},{key:"attachMediaElement",value:function(e){this.mediaElement=e,this.mediaElement.loop=!0,this.mediaSourceObjectURL=window.URL.createObjectURL(this.mediaSource),this.mediaElement.src=this.mediaSourceObjectURL,this.mediaElement.onerror=this.onError.bind(this),this.mediaElement.oncanplay=this.recordStartTime.bind(this),this.mediaElement.onstalled=this.checkState.bind(this)}},{key:"detachMediaElement",value:function(){this.mediaElement&&(this.mediaElement.onerror=null,this.mediaElement.oncanplay=null,this.mediaElement.onstalled=null)}},{key:"_onMediaSegment",value:function(){if(!this._initAppanded&&this.mccree.remuxBuffer.lastDts>500&&this._onInitSegment.call(this),this.clearBuffer.call(this),!(this.mccree.remuxBuffer.video.length<1||this.mccree.remuxBuffer.audio.length<1)&&this.asourceBuffer&&this.vsourceBuffer&&!this.vsourceBuffer.updating&&!this.asourceBuffer.updating)try{if(!this.mediaElement.error&&this.mccree.remuxBuffer.lastDts>500){var e=this.mccree.remuxBuffer.video.shift(),t=this.mccree.remuxBuffer.audio.shift();this.vsourceBuffer.appendBuffer(e.data),this.asourceBuffer.appendBuffer(t.data),this.seekables||(this.seekables=[]),e.seekable&&e.timestamp>0&&this.seekables.push(e.timestamp),this.checkState.bind(this)}else this.mediaElement.error&&this.observer.trigger("error",this.events.errorTypes.MEDIA_ERROR,"MediaMSEError",{code:11})}catch(e){e.code&&this.observer.trigger("error",this.events.errorTypes.MEDIA_ERROR,"MediaMSEError",{code:11}),this.logger.debug(this.TAG,"debug","储能槽错误。"+e.code)}}},{key:"_onInitSegment",value:function(){this.seekables=[],"open"!==this.mediaSource.readyState?this.mediaSource.addEventListener("sourceopen",this._appendInitSegment.bind(this)):this._appendInitSegment()}},{key:"_appendInitSegment",value:function(){var e=this.mccree.initSegment;if(!this._initAppanded&&e){this._initAppanded=!0,this.asourceBuffer=this.mediaSource.addSourceBuffer("audio/mp4;codecs="+this.mccree.media.tracks.audioTrack.meta.codec),this.asourceBuffer.appendBuffer(e.audio),this.vsourceBuffer=this.mediaSource.addSourceBuffer("video/mp4;codecs="+this.mccree.media.tracks.videoTrack.meta.codec),this.vsourceBuffer.appendBuffer(e.video);var t=this;t._onMediaSegment(),this.asourceBuffer.addEventListener("error",this.onError.bind(this)),this.vsourceBuffer.addEventListener("error",this.onError.bind(this)),this.mediaSource.addEventListener("error",this.onError.bind(this)),this.vsourceBuffer.addEventListener("updateend",this.checkState.bind(this));try{if(this.media&&this.media.mediaInfo&&this.media.mediaInfo.cdn_ip)this.mccree.cdnip=this.media.mediaInfo.cdn_ip;else if(this.url){var r=this.url.match(/(\d+)\.(\d+)\.(\d+)\.(\d+)/);this.mccree.cdnip=r&&r[0]}else this.mccree.cdnip="0.0.0.0";var i="",a="";i=this.mccree.media?this.mccree.media.tracks.audioTrack?this.mccree.media.tracks.audioTrack.meta?this.mccree.media.tracks.audioTrack.meta.codec:"AMNF":"ATNF":"Mccree uninitailized",
a=this.mccree.media?this.mccree.media.tracks.videoTrack?this.mccree.media.tracks.videoTrack.meta?this.mccree.media.tracks.videoTrack.meta.codec:"VMNF":"VTNF":"";var s={mimeType:'flv;codecs="'+i+","+a+'"',metadata:{encoder:this.mccree.media?this.mccree.media.mediaInfo.encoder:"UNKNOWN"},audioChannelCount:this.mccree.media?this.mccree.media.mediaInfo.audiochannels:0,audioDataRate:this.mccree.media?this.mccree.media.mediaInfo.audiodatarate:0,audioSampleRate:this.mccree.media?this.mccree.media.mediaInfo.audiosamplerate:0,fps:this.mccree.media?this.mccree.media.tracks.videoTrack.meta.frameRate.fps:0,videoDataRate:this.mccree.media?this.mccree.media.mediaInfo.videodatarate:0,height:this.mccree.media?this.mccree.media.mediaInfo.height:0,width:this.mccree.media?this.mccree.media.mediaInfo.width:0,cdnip:this.mccree.media?this.mccree.media.mediaInfo.cdn_ip:this.mccree.cdnip};this.observer.trigger("media_info",s)}catch(e){}}}},{key:"pause",value:function(){this.mediaElement.pause()}},{key:"destroy",value:function(){this.mediaSource&&this.asourceBuffer&&this.vsourceBuffer&&(this.mediaElement.pause(),URL.revokeObjectURL(this.mediaElement.src),this.asourceBuffer&&this.asourceBuffer.removeEventListener("error",this.onError.bind(this)),this.vsourceBuffer&&this.vsourceBuffer.removeEventListener("error",this.onError.bind(this)),this.vsourceBuffer&&this.vsourceBuffer.removeEventListener("updateend",this.checkState.bind(this)),this.mediaSource&&this.mediaSource.sourceBuffers>1&&(this.mediaSource.removeSourceBuffer(this.asourceBuffer),this.mediaSource.removeSourceBuffer(this.vsourceBuffer)),this.detachMediaElement(),that.asourceBuffer=null,that.vsourceBuffer=null,that.mediaSource=null,this._lastClearTime=0,that.seekables=[])}},{key:"onError",value:function(e){this.mediaElement&&this.mediaElement.error&&!this.reloading?this.observer.trigger("error",this.events.errorTypes.MEDIA_ERROR,"MediaMSEError",{code:11}):this.observer.trigger("error",this.events.errorTypes.OtherError,this.events.errorDetails.UNKNOWN)}},{key:"recordStartTime",value:function(){this.startTime||(this.startTime=(new Date).getTime())}}]),e}();t.default=a},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(){r(this,e)}return i(e,null,[{key:"uaMatch",value:function(e){void 0===e&&(e=window.navigator.userAgent),e=e.toLowerCase();var t=/(edge)\/([\w.]+)/.exec(e)||/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(iemobile)[\/]([\w.]+)/.exec(e)||/(version)(applewebkit)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+).*(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[],r=/(ipad)/.exec(e)||/(ipod)/.exec(e)||/(windows phone)/.exec(e)||/(iphone)/.exec(e)||/(kindle)/.exec(e)||/(silk)/.exec(e)||/(android)/.exec(e)||/(win)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||/(cros)/.exec(e)||/(playbook)/.exec(e)||/(bb)/.exec(e)||/(blackberry)/.exec(e)||[],i={},a={browser:t[5]||t[3]||t[1]||"",version:t[2]||t[4]||"0",versionNumber:t[4]||t[2]||"0",platform:r[0]||""};if(a.browser&&(i[a.browser]=!0,i.version=a.version,i.versionNumber=parseInt(a.versionNumber,10)),a.platform&&(i[a.platform]=!0),(i.android||i.bb||i.blackberry||i.ipad||i.iphone||i.ipod||i.kindle||i.playbook||i.silk||i["windows phone"])&&(i.mobile=!0),(i.cros||i.mac||i.linux||i.win)&&(i.desktop=!0),(i.chrome||i.opr||i.safari)&&(i.webkit=!0),i.rv||i.iemobile){var s="msie";a.browser=s,i[s]=!0}if(i.edge){delete i.edge;var n="msedge";a.browser=n,i[n]=!0}if(i.safari&&i.blackberry){var o="blackberry";a.browser=o,i[o]=!0}if(i.safari&&i.playbook){var u="playbook";a.browser=u,i[u]=!0}if(i.bb){var c="blackberry";a.browser=c,i[c]=!0}if(i.opr){var l="opera";a.browser=l,i[l]=!0}if(i.safari&&i.android){var h="android";a.browser=h,i[h]=!0}if(i.safari&&i.kindle){var d="kindle";a.browser=d,i[d]=!0}if(i.safari&&i.silk){var f="silk";a.browser=f,i[f]=!0}return i.name=a.browser,i.platform=a.platform,i}}]),e}();t.default=a},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=r(15),o=r(16),u=i(o),c=r(18),l=i(c),h=r(19),d=i(h),f=r(20),m=i(f),v=function(){function e(t){a(this,e),this.TAG="FLVDemuxer",this.type="demuxer",this._isFlv=!1,this._config=t||{},this._firstFragLoaded=!1,this._hasScript=!1,this._hasAudioSequence=!1,this._hasVideoSequence=!1,this._tracknum=0}return s(e,[{key:"reset",value:function(){this._isReseting=!0,this._isFlv=!1,this._firstFragLoaded=!1,this._hasScript=!1,this._hasAudioSequence=!1,this._hasVideoSequence=!1,this._tracknum=0}},{key:"init",value:function(e){this.mccree=e,this.logger=e.logger,this.observer=e.observer,this.events=e.events.events,this.errorTypes=e.events.errorTypes,this.errorDetails=e.events.errorDetails,this.logMsgs=e.events.logMsgs,this.observer.on(this.events.FRAG_LOADED,this._fragLoaded.bind(this))}},{key:"_fragLoaded",value:function(){if(this._firstFragLoaded){if(this.mccree.loaderBuffer.length<11)return;var e=this._parseFlvTag();e&&(e!==-1&&this.logger.error(this.TAG,this.type,{}),this._fragLoaded())}else{if(this.mccree.loaderBuffer.length<13)return;var t=this._config.playType,r=this.mccree.loaderBuffer.shift(13);this._parseFlvHeader(r,t),this._fragLoaded()}}},{key:"_parseFlvHeader",value:function(e,t){var r=0;if(70!==e[0]||76!==e[1]||86!==e[2]||1!==e[3])this.observer.trigger(this.events.demux.DEMUXER_MISSMATCH,e),this._fragLoaded();else{this._firstFragLoaded=!0,r+=4;var i=this._switchPlayType(e[r],t);if(i&!0){this._tracknum++;var a=new n.VideoTrack;this.mccree.media.tracks.videoTrack=a,this._setDefaultVideoConfig()}if(i&!0){this._tracknum++;var s=new n.AudioTrack;this.mccree.media.tracks.audioTrack=s,this._setDefaultAudioConfig()}this._fragLoaded()}}},{key:"_switchPlayType",value:function(e,t){var r=5;switch(t){case"audio":r=4;break;case"video":r=5;break;default:r=e?e:5}return r}},{key:"_setDefaultVideoConfig",value:function(){var e=this.mccree.media.tracks.videoTrack;e.meta=l.default,e.id=e.meta.id=this._tracknum}},{key:"_setDefaultAudioConfig",value:function(){var e=this.mccree.media.tracks.audioTrack;e.meta=d.default,e.id=e.meta.id=this._tracknum}},{key:"_parseFlvTag",value:function(){if(this.mccree.loaderBuffer.length<11)return null;var e=this._parseFlvTagHeader();e&&this._processChunk(e)}},{key:"_parseFlvTagHeader",value:function(){var e={},t=this.mccree.loaderBuffer.toInt(0,1);if(e.filtered=(32&t)>>>5,e.tagType=31&t,e.datasize=this.mccree.loaderBuffer.toInt(1,3),8!==e.tagType&&9!==e.tagType&&11!==e.tagType&&18!==e.tagType||0!==this.mccree.loaderBuffer.toInt(8,3))return this.loaderBuffer&&this.loaderBuffer.length>0&&this.loaderBuffer.shift(1),this.logger.warn(this.TAG,this.type," tagType"+e.tagType),null;if(this.mccree.loaderBuffer.length<e.datasize+15)return null;this.mccree.loaderBuffer.shift(4);var r=this.mccree.loaderBuffer.toInt(0,3);this.mccree.loaderBuffer.shift(3);var i=this.mccree.loaderBuffer.shift(1)[0];return i>0&&(r+=16777216*i),e.timestamp=r,this.mccree.loaderBuffer.shift(3),e}},{key:"_processChunk",value:function(e){switch(e.tagType){case 18:this._parseScriptData(e);break;case 8:this._parseAACData(e);break;case 9:this._parseAVCData(e);break;case 11:this.mccree.loaderBuffer.shift(3);break;default:this.mccree.loaderBuffer.shift(1)}this._fragLoaded()}},{key:"_clearBuffer",value:function(){this.logger.debug(this.TAG,this.type,"清除缓存")}},{key:"_parseScriptData",value:function(e){var t=this.mccree.media.tracks.audioTrack,r=this.mccree.media.tracks.videoTrack,i=this.mccree.loaderBuffer.shift(e.datasize),a=this.mccree.media.mediaInfo=new m.default(i).parseMetadata(),s=this._datasizeValidator(e.datasize);if(s&&(this._hasScript=!0),t&&!t.hasSpecificConfig){var n=t.meta;switch(a.audiosamplerate&&(n.audioSampleRate=a.audiosamplerate),a.audiochannels&&(n.channelCount=a.audiochannels),a.audiosamplerate){case 44100:n.sampleRateIndex=4;break;case 22050:n.sampleRateIndex=7;break;case 11025:n.sampleRateIndex=10}}if(r&&!r.hasSpecificConfig){var o=r.meta;if("number"==typeof a.framerate){var u=Math.floor(1e3*a.framerate);if(u>0){var c=u/1e3;o.frameRate||(o.frameRate={}),o.frameRate.fixed=!0,o.frameRate.fps=c,o.frameRate.fps_num=u,o.frameRate.fps_den=1e3}}}}},{key:"_parseAACData",value:function(e){var t=this.mccree.media.tracks.audioTrack;if(t){var r=t.meta;r||(r=d.default);var i=this.mccree.loaderBuffer.shift(1)[0];e.data=this.mccree.loaderBuffer.shift(e.datasize-1);var a=(240&i)>>>4;t.format=a,10!==a&&this.observer.trigger("error",this.mccree.events.MEDIA_ERROR,{}),10!==a||this._hasAudioSequence||(r.audioSampleRate=this._switchAudioSamplingFrequency(i),r.sampleRateIndex=(12&i)>>>2,r.frameLenth=(2&i)>>>1,r.channelCount=1&i,r.refSampleDuration=Math.floor(1024/r.audioSampleRate*r.timescale));var s=r.audioSampleRate,n=r.sampleRateIndex,o=r.refSampleDuration;delete e.tagType;var u=this._datasizeValidator(e.datasize);if(0===e.data[0]){var c=this._aacSequenceHeaderParser(e.data);s=c.audiosamplerate||r.audioSampleRate,n=c.sampleRateIndex||r.sampleRateIndex,o=Math.floor(1024/s*r.timescale),r.channelCount=c.channelCount,r.audioSampleRate=s,r.sampleRateIndex=n,r.refSampleDuration=o,this._hasAudioSequence=!0,!this._hasScript||this.mccree.media.tracks.videoTrack&&!this._hasVideoSequence||this.observer.trigger("METADATA_PARSED")}else e.data=e.data.slice(1,e.data.length),this.observer.trigger("AUDIODATA_PARSED"),t.samples.push(e);u||this.logger.warn(this.TAG,this.type,"TAG 长度确认有误"+e.datasize)}}},{key:"_parseAVCData",value:function(e){var t=this.mccree.loaderBuffer.shift(1)[0];e.frameType=(240&t)>>>4;var r=15&t;if(this.mccree.media.tracks.videoTrack.codecID=r,7===r)if(e.avcPacketType=this.mccree.loaderBuffer.shift(1)[0],e.compositionTime=this.mccree.loaderBuffer.toInt(0,3),this.mccree.loaderBuffer.shift(3),e.data=this.mccree.loaderBuffer.shift(e.datasize-5),0===e.avcPacketType){this._avcSequenceHeaderParser(e.data);var i=this._datasizeValidator(e.datasize);i&&(this._hasVideoSequence=!0,!this._hasScript||this.mccree.media.tracks.audioTrack&&!this._hasAudioSequence||this.observer.trigger("METADATA_PARSED"))}else this._datasizeValidator(e.datasize)||this.logger.warn(this.TAG,this.type,"TAG 长度确认有误"+e.datasize),this.observer.trigger("VIDEODATA_PARSED"),this.mccree.media.tracks.videoTrack.samples.push(e);else e.data=this.mccree.loaderBuffer.shift(e.datasize-1),this._datasizeValidator(e.datasize)||this.logger.warn(this.TAG,this.type,"TAG 长度确认有误"+e.datasize),this.observer.trigger("VIDEODATA_PARSED"),this.mccree.media.tracks.videoTrack.samples.push(e);delete e.tagType}},{key:"_datasizeValidator",value:function(e){var t=this.mccree.loaderBuffer.toInt(0,4);this.mccree.loaderBuffer.shift(4);var r=t===e+11;return r}},{key:"_switchAudioSamplingFrequency",value:function(e){var t=(12&e)>>>2,r=[5500,11025,22050,44100];return r[t]}},{key:"_switchAudioChannel",value:function(e){var t=1&e,r=[1,2];return r[t]}},{key:"_aacSequenceHeaderParser",value:function(e){var t={};return t.hasSpecificConfig=!0,t.objectType=e[1]>>>3,t.sampleRateIndex=(7&e[1])<<1|e[2]>>>7,t.audiosamplerate=this._switchAudioSampleRate(t.sampleRateIndex),t.channelCount=(120&e[2])>>>3,t.frameLength=(4&e[2])>>>2,t.dependsOnCoreCoder=(2&e[2])>>>1,t.extensionFlagIndex=1&e[2],t}},{key:"_switchAudioSampleRate",value:function(e){var t=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];return t[e]}},{key:"_avcSequenceHeaderParser",value:function(e){var t=this.mccree.media.tracks.videoTrack;if(t){var r=0;t.meta||(t.meta=l.default);var i=t.meta;i.configurationVersion=e[0],i.avcProfileIndication=e[1],i.profileCompatibility=e[2],i.avcLevelIndication=e[3]/10,i.nalUnitLength=(3&e[4])+1;var a=31&e[5];r=6;for(var s={},n=0;n<a;n++){var o=255*e[r]+e[r+1];r+=2;for(var c=new Uint8Array(o),h=0;h<o;h++)c[h]=e[r+h];for(var d="avc1.",f=1;f<4;f++){var m=c[f].toString(16);m.length<2&&(m="0"+m),d+=m}i.codec=d,r+=o,s=u.default.parseSPS(c)}var v=e[r];r++;for(var p=0;p<v;p++){var g=255*e[r]+e[r+1];r+=2;for(var y=new Uint8Array(g),b=0;b<g;b++)y[b]=e[r+b];r+=g,this.mccree.media.tracks.videoTrack.pps=y}s&&s.codec_size&&(i.codecWidth=s.codec_size.width,i.codecHeight=s.codec_size.height,i.presentWidth=s.present_size.width,i.presentHeight=s.present_size.height),i.profile=s.profile_string||i.profile,i.level=s.level_string||i.level,i.bitDepth=s.bit_depth||i.bitDepth,i.chromaFormat=s.chroma_format||i.chromaFormat,i.sarRatio&&(i.sarRatio.width=s.sar_ratio.width,i.sarRatio.height=s.sar_ratio.height),i.frameRate&&s.frame_rate.fixed&&s.frame_rate.fps_num>0&&s.frame_rate.fps_den>0&&(i.frameRate=s.frame_rate);var _=i.frameRate.fps_den,k=i.frameRate.fps_num;i.refSampleDuration=Math.floor(i.timescale*(_/k)),i.avcc=new Uint8Array(e.length),i.avcc.set(e),t.meta=i}}}]),e}();t.default=v},function(e,t){"use strict";function r(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=function(){function e(){a(this,e),this.TAG="Track",this.id=-1,this.sequenceNumber=0,this.samples=[],this.length=0}return s(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"distroy",value:function(){this.reset(),this.id=-1}}]),e}();t.default=n;t.AudioTrack=function(e){function t(){a(this,t);var e=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="AudioTrack",e.type="audio",e}return i(t,e),t}(n),t.VideoTrack=function(e){function t(){a(this,t);var e=r(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e}return i(t,e),s(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),t}(n)},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=r(17),o=i(n),u=function(){function e(){a(this,e)}return s(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,r=t.byteLength,i=new Uint8Array(r),a=0,s=0;s<r;s++)s>=2&&3===t[s]&&0===t[s-1]&&0===t[s-2]||(i[a]=t[s],a++);return new Uint8Array(i.buffer,0,a)}},{key:"parseSPS",value:function(t){var r=e._ebsp2rbsp(t),i=new o.default(r);i.readByte();var a=i.readByte();i.readByte();var s=i.readByte();i.readUEG();var n=e.getProfileString(a),u=e.getLevelString(s),c=1,l=420,h=[0,420,422,444],d=8;if((100===a||110===a||122===a||244===a||44===a||83===a||86===a||118===a||128===a||138===a||144===a)&&(c=i.readUEG(),3===c&&i.readBits(1),c<=3&&(l=h[c]),d=i.readUEG()+8,i.readUEG(),i.readBits(1),i.readBool()))for(var f=3!==c?8:12,m=0;m<f;m++)i.readBool()&&(m<6?e._skipScalingList(i,16):e._skipScalingList(i,64));i.readUEG();var v=i.readUEG();if(0===v)i.readUEG();else if(1===v){i.readBits(1),i.readSEG(),i.readSEG();for(var p=i.readUEG(),g=0;g<p;g++)i.readSEG()}i.readUEG(),i.readBits(1);var y=i.readUEG(),b=i.readUEG(),_=i.readBits(1);0===_&&i.readBits(1),i.readBits(1);var k=0,T=0,E=0,w=0,A=i.readBool();A&&(k=i.readUEG(),T=i.readUEG(),E=i.readUEG(),w=i.readUEG());var S=1,D=1,M=0,R=!0,B=0,x=0,O=i.readBool();if(O){if(i.readBool()){var L=i.readByte(),I=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],N=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];L>0&&L<16?(S=I[L-1],D=N[L-1]):255===L&&(S=i.readByte()<<8|i.readByte(),D=i.readByte()<<8|i.readByte())}if(i.readBool()&&i.readBool(),i.readBool()&&(i.readBits(4),i.readBool()&&i.readBits(24)),i.readBool()&&(i.readUEG(),i.readUEG()),i.readBool()){var U=i.readBits(32),C=i.readBits(32);R=i.readBool(),B=C,x=2*U,M=B/x}}var P=1;1===S&&1===D||(P=S/D);var G=0,F=0;if(0===c)G=1,F=2-_;else{var j=3===c?1:2,z=1===c?2:1;G=j,F=z*(2-_)}var W=16*(y+1),H=(2-_)*(16*(b+1));W-=(k+T)*G,H-=(E+w)*F;var V=Math.ceil(W*P);return i.destroy(),i=null,{profile_string:n,level_string:u,bit_depth:d,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:R,fps:M,fps_den:x,fps_num:B},sar_ratio:{width:S,height:D},codec_size:{width:W,height:H},present_size:{width:V,height:H}}}},{key:"_skipScalingList",value:function(e,t){for(var r=8,i=8,a=0,s=0;s<t;s++)0!==i&&(a=e.readSEG(),i=(r+a+256)%256),r=0===i?r:i}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}}]),e}();t.default=u},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=function(){function e(t){r(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return i(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),r=new Uint8Array(4);r.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(r.buffer).getUint32(0,!1),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){if(e<=this._currentWordBitsLeft){var t=this._currentWord>>>32-e;return this._currentWord<<=e,this._currentWordBitsLeft-=e,t}var r=this._currentWordBitsLeft?this._currentWord:0;r>>>32-this._currentWordBitsLeft;var i=e-this._currentWordBitsLeft;this._fillCurrentWord();var a=Math.min(i,this._currentWordBitsLeft),s=this._currentWord>>>32-a;return this._currentWord<<=a,this._currentWordBitsLeft-=a,r=r<<a|s}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!==(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}();t.default=a},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={avcc:null,chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,sarRatio:{height:1,width:1},timescale:1e3,type:"video"};t.default=r},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r={audioSampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};t.default=r},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),s=function(){function e(t){r(this,e),this.offset=0,this.data=t}return a(e,[{key:"parseMetadata",value:function(){var e={};try{for(var t=this.parseAMF(),r=0;r<t.length-1;r++)"string"==typeof t[r]&&"onMetaData"===t[r]&&"object"===i(t[r+1])&&(e=t[r+1])}catch(e){}return e}},{key:"parseAMF",value:function(){for(var e=[];this.offset<this.data.length;){var t=this.data[this.offset];this.offset++;var r=this._switchAmfType(t);e.push(r)}return e}},{key:"_switchAmfType",value:function(e){var t=null;switch(e){case 0:t=this._parseNum();break;case 1:t=this._parseBoolean();break;case 2:t=this._parseString();break;case 3:t=this._parseObject();break;case 4:t="MovieClip",this.offset++;break;case 5:t=null,this.offset++;break;case 6:t=void 0,this.offset++;break;case 8:t=this._parseECMAArrary()}return t}},{key:"_parseNum",value:function(){var e=this.data.slice(this.offset,this.offset+8);return this.offset+=8,new DataView(e.buffer).getFloat64(0)}},{key:"_parseString",value:function(){var e=this.data.slice(this.offset,this.offset+2),t=256*e[0]+e[1];this.offset+=2;var r=this.data.slice(this.offset,this.offset+t);this.offset+=t;var i=new TextDecoder("utf-8").decode(r);return i}},{key:"_parseObject",value:function(){for(var e={};this.offset<this.data.length-2&&9!==this.data[this.offset+2];){var t=this._parseString(),r=this.data[this.offset];this.offset++;var i=this._switchAmfType(r);e[t]=i}return this.offset+=3,e}},{key:"_parseECMAArrary",value:function(){return this.offset+=4,this._parseObject()}},{key:"_parseBoolean",value:function(){return this.offset++,!(0===this.data[0])}}]),e}();t.default=s},function(e,t,r){"use strict";function i(e){return e&&e.__esModule?e:{default:e}}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),n=r(22),o=i(n),u=r(13),c=i(u),l=function(){function e(t){a(this,e),this.TAG="MP4Remuxer",this.type="remuxer",this._config=t||{},this._isLive=this._config.isLive,this._dtsBase=0,this._dtsBaseInited=!1,this._audioDtsBase=1/0,this._videoDtsBase=1/0,this._audioNextDts=void 0,this._videoNextDts=void 0,this._audioMeta=null,this._videoMeta=null,this._browser=c.default.uaMatch()}return s(e,[{key:"init",value:function(e){this.mccree=e,this.logger=e.logger,this.observer=e.observer,this.events=e.events,this.onMediaSegment=e.onMediaSegment,this.mccree.initSegment={},this.mccree.remuxBuffer={audio:[],video:[]},this.observer.on("METADATA_PARSED",this._generateInitailSegment.bind(this)),this.observer.on("VIDEODATA_PARSED",this.timmerCallback.bind(this))}},{key:"destroy",value:function(){this._dtsBase=0,this._dtsBaseInited=!1,this._audioDtsBase=1/0,this._videoDtsBase=1/0,this._audioNextDts=void 0,this._videoNextDts=void 0,this._audioMeta=null,this._videoMeta=null}},{key:"timmerCallback",value:function(){this.mccree.media.tracks.videoTrack&&this.mccree.media.tracks.audioTrack&&this._generateBoxes()}},{key:"_generateInitailSegment",value:function(){o.default.init(),this._fixRatio();var e=this.mccree.media.tracks.audioTrack,t=this.mccree.media.tracks.videoTrack;if(e.isAAC=10===e.format,this._generateConfig(),t.meta){var r=o.default.initSegment([t]);this.mccree.initSegment.video=r;var i=o.default.initSegment([e]);this.mccree.initSegment.audio=i,this.observer.trigger("INIT_SEGMENT_REMUXED"),this._generateBoxes()}}},{key:"_fixRatio",value:function(){var e=this.mccree.media.mediaInfo||{},t=this.mccree.media.tracks.videoTrack||{},r=t.meta||{},i=r.codecHeight,a=r.codecWidth;e.width===r.codecWidth&&e.height===r.codecHeight||r.height!==9*r.width/16&&(a=e.width?e.width:parseInt(16*r.height/9),i=e.height?e.height:parseInt(9*r.width/16),r.codecHeight=i,r.codecWidth=a,r.presentHeight=i,r.presentWidth=a)}},{key:"_generateConfig",value:function(){var e=this.mccree.media.tracks.audioTrack,t=e.meta,r=[],i=e.objectType,a=t.sampleRateIndex,s=void 0,n=t.channelCount,o=navigator.userAgent.toLowerCase();o.indexOf("firefox")!==-1?a>=6?(i=5,s=a-3):(i=2,r=new Array(2),s=a):o.indexOf("android")!==-1?(i=2,s=a):(i=5,s=a,a>=6?s=a-3:1===n&&(i=2,s=a)),r[0]=i<<3,r[0]|=(15&a)>>>1,r[1]=(15&a)<<7,r[1]|=(15&n)<<3,5===i&&(r[1]|=(15&a)>>>1,r[2]=(1&a)<<7,r[2]|=8,r[3]=0),t.config=r,t.codec="mp4a.40."+i}},{key:"_generateBoxes",value:function(){var e=this.mccree.media.tracks.videoTrack,t=this.mccree.media.tracks.audioTrack,r=-1,i=null,a=-1;if(!this._dtsBaseInited&&e.samples.length>1&&t.samples.length>1&&this._calculateDtsBase(t,e),e.meta&&t.meta&&!(e.samples.length<15)){e.samples[0].timestamp+e.samples[0].compositionTime;if(r=10,!(r<1||e.samples.length<=r+1)){var s=Math.ceil((r+1)*e.meta.refSampleDuration/t.meta.refSampleDuration)+1;t.samples.length<=s||t.samples.length<r||(e.samples.length>r&&(a=e.samples[r].timestamp,i=e.samples.splice(0,r)),i&&((this._browser.chrome&&this._browser.versionNumber<=50||this._browser.mozilla)&&(i[0].frameType=1),this._generateGop(i,i[0].timestamp,a),this._generateBoxes()))}}}},{key:"_generateGop",value:function(e,t,r){for(var i=t,a=t,s=this.mccree.media.tracks.videoTrack,n=s.meta.refSampleDuration,u=0,c=[],l=0;l<e.length;l++)u+=e[l].data.length;var h=8+u,d=new Uint8Array(h);d[0]=h>>>24&255,d[1]=h>>>16&255,d[2]=h>>>8&255,d[3]=255&h,d.set(o.default.types.mdat,4);for(var f=8,m=0;m<e.length;m++){var v=e[m];e[m+1]?(a=e[m+1].timestamp,n=a-i,i=a):(a=r,n=a-i,i=a),n>s.meta.refSampleDuration+1&&(this.observer.trigger("FRAME_DROPPED",Math.floor(n/s.meta.refSampleDuration)),this.logger.debug(this.TAG,this.type,"检测到视频掉帧 掉帧时间点："+i)),this.mccree.media.videoDuration+=n;var p={dts:v.timestamp-this._dtsBase,pts:v.compositionTime+v.timestamp-this._dtsBase,cts:v.compositionTime,size:v.data.length,isKeyframe:1===v.frameType,duration:n+1,originalDts:i,flags:{isLeading:0,dependsOn:1===v.frameType?2:1,isDependedOn:1===v.frameType?1:0,hasRedundancy:0,isNonSync:1===v.frameType?0:1}};d.set(v.data,f),f+=v.data.length,c.push(p),this.mccree.remuxBuffer.lastDts=p.dts}var g={id:s.id,samples:c};s.sequenceNumber++;var y=o.default.moof(s.sequenceNumber,t-this._dtsBase,g);this.mccree.remuxBuffer.video.push({type:"video",seekable:c[0].isKeyframe,timestamp:c[0].dts,data:this._mergeBoxes(y,d)}),this.observer.trigger("MEDIA_SEGMENT_REMUXED",e.length),this._remuxAudio(t,r)}},{key:"_remuxAudio",value:function(e,t){for(var r=e,i=e,a=(this.mccree.media.tracks.videoTrack,this.mccree.media.tracks.audioTrack),s=a.meta.refSampleDuration,n=a.samples,u=0,c=[],l=[];n[0]&&n[0].timestamp+s<e;)this.logger.warn(this.TAG,this.type,"检测到音频掉帧/正在进行追帧，追帧时间点："+n[0].timestamp),n.shift();e=n[0].timestamp;var h=n[0];for(n[0].timestamp;n.length>0&&n[0].timestamp<=t;){h=n.shift(),n[0]?(r=h.timestamp,i=n[0].timestamp):(r=h.timestamp,i=h.timestamp+s),h.sampleDuration=i-r,this.mccree.media.audioDuration+=h.sampleDuration;var d={dts:h.timestamp,pts:h.timestamp,cts:0,size:h.data.length,duration:h.sampleDuration,originalDts:r,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};l.push(d),u+=h.data.length,c.push(h.data)}for(;this.mccree.media.videoDuration-this.mccree.media.audioDuration>a.meta.refSampleDuration+1;){this.logger.debug(this.TAG,this.type,"检测到音频掉帧，正在进行补偿 基准时间点："+r+" 补偿时间点："+i),r=i,i=r+h.sampleDuration;var f={dts:r,pts:r,cts:0,size:h.data.length,duration:h.sampleDuration,originalDts:r,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0}};this.mccree.media.audioDuration+=h.sampleDuration,l.push(f),u+=h.data.length,c.push(h.data)}var m=u+8,v=8,p=new Uint8Array(m);p[0]=m>>>24&255,p[1]=m>>>16&255,p[2]=m>>>8&255,p[3]=255&m,p.set(o.default.types.mdat,4);for(var g=0;g<c.length;g++)p.set(c[g],v),v+=c[g].length;var y={id:a.id,samples:l};a.sequenceNumber++;var b=o.default.moof(a.sequenceNumber,e-this._dtsBase,y);this.mccree.remuxBuffer.audio.push({type:"audio",data:this._mergeBoxes(b,p)})}},{key:"_calculateDtsBase",value:function(e,t){this._dtsBaseInited||(e.samples&&e.samples.length&&(this._audioDtsBase=e.samples[0].timestamp),t.samples&&t.samples.length&&(this._videoDtsBase=t.samples[0].timestamp),this._dtsBase=Math.min(this._audioDtsBase,this._videoDtsBase),this._dtsBaseInited=!0)}},{key:"_mergeBoxes",value:function(e,t){var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(e,0),r.set(t,e.byteLength),r}}]),e}();t.default=l},function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),a=Math.pow(2,32)-1,s=function(){function e(){r(this,e)}return i(e,null,[{key:"init",value:function(){e.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],hvcc:[],".mp3":[]};var t=void 0;for(t in e.types)e.types.hasOwnProperty(t)&&(e.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);var r=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);e.HDLR_TYPES={video:r,audio:i};var a=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);e.STTS=e.STSC=e.STCO=s,e.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),e.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),e.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),e.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var n=new Uint8Array([105,115,111,109]),o=new Uint8Array([97,118,99,49]),u=new Uint8Array([0,0,0,1]);e.FTYP=e.box(e.types.ftyp,n,u,n,o),e.DINF=e.box(e.types.dinf,e.box(e.types.dref,a))}},{key:"box",value:function(e){for(var t=Array.prototype.slice.call(arguments,1),r=8,i=t.length,a=i,s=void 0;i--;)r+=t[i].byteLength;
for(s=new Uint8Array(r),s[0]=r>>24&255,s[1]=r>>16&255,s[2]=r>>8&255,s[3]=255&r,s.set(e,4),i=0,r=8;i<a;i++)s.set(t[i],r),r+=t[i].byteLength;return s}},{key:"hdlr",value:function(t){return e.box(e.types.hdlr,e.HDLR_TYPES[t])}},{key:"mdat",value:function(t){return e.box(e.types.mdat,t)}},{key:"mdhd",value:function(t,r){r*=t;var i=Math.floor(r/(a+1)),s=Math.floor(r%(a+1));return e.box(e.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,s>>24,s>>16&255,s>>8&255,255&s,85,196,0,0]))}},{key:"mdia",value:function(t){return e.box(e.types.mdia,e.mdhd(t.timescale,t.duration),e.hdlr(t.type),e.minf(t))}},{key:"mfhd",value:function(t){return e.box(e.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}},{key:"minf",value:function(t){return"audio"===t.type?e.box(e.types.minf,e.box(e.types.smhd,e.SMHD),e.DINF,e.stbl(t)):e.box(e.types.minf,e.box(e.types.vmhd,e.VMHD),e.DINF,e.stbl(t))}},{key:"moof",value:function(t,r,i){return e.box(e.types.moof,e.mfhd(t),e.traf(i,r))}},{key:"moov",value:function(t){for(var r=t.length,i=[];r--;)i[r]=e.trak(t[r].meta);return e.box.apply(null,[e.types.moov,e.mvhd(t[0].meta.timescale,t[0].meta.duration)].concat(i).concat(e.mvex(t)))}},{key:"mvex",value:function(t){for(var r=t.length,i=[];r--;)i[r]=e.trex(t[r]);return e.box.apply(null,[e.types.mvex].concat(i))}},{key:"mvhd",value:function(t,r){r*=t;var i=Math.floor(r/(a+1)),s=Math.floor(r%(a+1)),n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,s>>24,s>>16&255,s>>8&255,255&s,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.box(e.types.mvhd,n)}},{key:"sdtp",value:function(t){var r,i=t.samples||[],a=new Uint8Array(4+i.length),s=t.flags;for(r=0;r<i.length;r++)s=i[r].flags,a[r+4]=s.dependsOn<<4|s.isDependedOn<<2|s.hasRedundancy;return e.box(e.types.sdtp,a)}},{key:"stbl",value:function(t){return e.box(e.types.stbl,e.stsd(t),e.box(e.types.stts,e.STTS),e.box(e.types.stsc,e.STSC),e.box(e.types.stsz,e.STSZ),e.box(e.types.stco,e.STCO))}},{key:"avc1",value:function(t){var r=t.avcc,i=t.codecWidth,a=t.codecHeight,s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,i>>>8&255,255&i,a>>>8&255,255&a,0,72,0,0,0,72,0,0,0,0,0,0,0,1,10,120,113,113,47,102,108,118,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255]);return e.box(e.types.avc1,s,e.box(e.types.avcC,r))}},{key:"esds",value:function(e){var t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}},{key:"mp4a",value:function(t){var r=t.audiosamplerate;return e.box(e.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,r>>8&255,255&r,0,0]),e.box(e.types.esds,e.esds(t)))}},{key:"mp3",value:function(t){var r=t.audiosamplerate;return e.box(e.types[".mp3"],new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,r>>8&255,255&r,0,0]))}},{key:"stsd",value:function(t){return"audio"===t.type?t.isAAC||"mp3"!==t.codec?e.box(e.types.stsd,e.STSD,e.mp4a(t)):e.box(e.types.stsd,e.STSD,e.mp3(t)):e.box(e.types.stsd,e.STSD,e.avc1(t))}},{key:"tkhd",value:function(t){var r=t.id,i=t.duration*t.timescale,s=t.presentWidth,n=t.presentHeight,o=Math.floor(i/(a+1)),u=Math.floor(i%(a+1));return e.box(e.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,0,o>>24,o>>16&255,o>>8&255,255&o,u>>24,u>>16&255,u>>8&255,255&u,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,255&s,0,0,n>>8&255,255&n,0,0]))}},{key:"traf",value:function(t,r){var i=e.sdtp(t),s=t.id,n=Math.floor(r/(a+1)),o=Math.floor(r%(a+1));return e.box(e.types.traf,e.box(e.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s])),e.box(e.types.tfdt,new Uint8Array([1,0,0,0,n>>24,n>>16&255,n>>8&255,255&n,o>>24,o>>16&255,o>>8&255,255&o])),e.trun(t,i.length+16+20+8+16+8+8),i)}},{key:"trak",value:function(t){return t.duration=t.duration||4294967295,e.box(e.types.trak,e.tkhd(t),e.mdia(t))}},{key:"trex",value:function(t){var r=t.id;return e.box(e.types.trex,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function(t,r){var i,a,s,n,o,u,c=t.samples||[],l=c.length,h=12+16*l,d=new Uint8Array(h);for(r+=8+h,d.set([0,0,15,1,l>>>24&255,l>>>16&255,l>>>8&255,255&l,r>>>24&255,r>>>16&255,r>>>8&255,255&r],0),i=0;i<l;i++)a=c[i],s=a.duration,n=a.size,o=a.flags,u=a.cts,d.set([s>>>24&255,s>>>16&255,s>>>8&255,255&s,n>>>24&255,n>>>16&255,n>>>8&255,255&n,o.isLeading<<2|o.dependsOn,o.isDependedOn<<6|o.hasRedundancy<<4|o.paddingValue<<1|o.isNonSync,61440&o.degradPrio,15&o.degradPrio,u>>>24&255,u>>>16&255,u>>>8&255,255&u],12+16*i);return e.box(e.types.trun,d)}},{key:"initSegment",value:function(t){e.types||e.init();var r,i=e.moov(t);return r=new Uint8Array(e.FTYP.byteLength+i.byteLength),r.set(e.FTYP),r.set(i,e.FTYP.byteLength),r}}]),e}();t.default=s}]);